<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ultimate Coin Clicker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f7fa;
  --card: #ffffff;
  --accent: #1e90ff;
  --accent-dark: #1c7ed6;
  --text-primary: #1f2937;
  --text-muted: #6b7280;
  --button-gray: #e5e7eb;
  --hover-shadow: rgba(0,0,0,0.15);
  --btn-shadow: 0 4px 12px rgba(0,0,0,0.08);
  --btn-hover-shadow: 0 6px 16px rgba(0,0,0,0.12);
  --leaderboard-bg: #2d3748;
}
* { box-sizing: border-box; margin:0; padding:0; font-family: 'Inter', sans-serif; }
body { background: var(--bg); display:flex; justify-content:center; align-items:center; min-height:100vh; }

.container { width: 380px; max-width:95%; background: var(--card); border-radius: 16px; padding: 25px; box-shadow: 0 12px 30px rgba(0,0,0,0.08); text-align:center; position:relative; }
.top { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; gap:10px; }
.user { display:flex; align-items:center; gap:10px; color: var(--text-muted); font-size:14px; min-height:40px; text-align:left; }
.avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
.controls { display:flex; gap:8px; align-items:center; }
button.small { padding:8px 14px; font-size:13px; border-radius:10px; border:none; cursor:pointer; background:var(--button-gray); color: var(--text-primary); transition: background-color 0.2s, transform 0.1s; }
button.small:hover { background:#d1d5db; transform: translateY(-1px); }
button.small:active { transform: translateY(0); }

#coin-count { font-size:32px; font-weight:700; margin-bottom:25px; color:var(--text-primary); }

#click-button { position:relative; overflow:hidden; padding:20px 60px; font-size:20px; color:white; background-color:var(--button-gray); border:none; border-radius:16px; cursor:not-allowed; outline:none; display:inline-flex; align-items:center; justify-content:center; min-width:240px; transition: all 0.2s ease; box-shadow: var(--btn-shadow); }
#click-button.enabled { background-color: var(--accent); cursor:pointer; }
#click-button.enabled:hover { transform: scale(1.05); box-shadow: var(--btn-hover-shadow); }
#click-button:active.enabled { transform: scale(0.98); background-color: var(--accent-dark); }

.spinner { border:3px solid rgba(255,255,255,0.28); border-top:3px solid rgba(255,255,255,0.98); border-radius:50%; width:20px; height:20px; animation:spin 900ms linear infinite; margin-right:10px; display:inline-block; vertical-align:middle; }
@keyframes spin { to { transform: rotate(360deg); } }

.ripple { position:absolute; border-radius:50%; transform:scale(0); animation:ripple 600ms linear; background: rgba(255,255,255,0.4); pointer-events:none; will-change: transform, opacity; }
@keyframes ripple { to { transform: scale(4); opacity:0; } }

.meta { color:var(--text-muted); font-size:13px; margin-top:20px; }

#leaderboard-btn { margin-top:20px; padding:12px 24px; font-size:16px; border-radius:12px; border:none; background:var(--accent); color:white; cursor:pointer; transition:background-color 0.2s, transform 0.1s; box-shadow: var(--btn-shadow); }
#leaderboard-btn:hover { background:var(--accent-dark); transform: translateY(-1px); box-shadow: var(--btn-hover-shadow); }
#leaderboard-btn:active { transform: translateY(0); }

#leaderboard { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); display:none; flex-direction:column; justify-content:center; align-items:center; border-radius:16px; padding:25px; overflow-y:auto; }
#leaderboard .close { align-self:flex-end; margin-bottom:15px; cursor:pointer; font-size:24px; font-weight:700; color:white; transition: transform 0.2s; }
#leaderboard .close:hover { transform: scale(1.1); }
#leaderboard h2 { color:white; margin-bottom:20px; font-size:24px; }
.leaderboard-entry { background:rgba(255,255,255,0.95); width:95%; max-width: 320px; padding:12px 18px; border-radius:12px; display:flex; align-items:center; gap:12px; margin-bottom:10px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
.leaderboard-entry img { width:36px; height:36px; border-radius:50%; object-fit:cover; }
.shimmer { background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0.1) 75%); background-size:200% 100%; animation: shimmer 1.5s infinite; border-radius:8px; }
@keyframes shimmer { 0% { background-position:-200% 0; } 100% { background-position:200% 0; } }

.sell-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid #e5e7eb; }
.sell-section input { width: 100px; padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; text-align: center; }
.sell-section button { padding: 8px 16px; border-radius: 8px; border: none; background: #f97316; color: white; cursor: pointer; transition: background-color 0.2s; }
.sell-section button:hover { background: #ea580c; }
#sold-coins-count { font-weight: 600; margin-top: 10px; color: var(--text-primary); }

.alert-ui {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 20px 30px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    z-index: 1000;
    text-align: center;
    min-width: 250px;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}
.alert-ui.show { opacity: 1; }
.alert-ui h3 { margin-bottom: 10px; color: var(--text-primary); }
.alert-ui p { font-size: 14px; color: var(--text-muted); margin-bottom: 15px; }
.alert-ui button { padding: 8px 20px; border-radius: 8px; border: none; background: var(--accent); color: white; cursor: pointer; }
.alert-ui button:hover { background: var(--accent-dark); }
</style>
</head>
<body>
<div class="container">
  <div class="top">
    <div class="user" id="user-info"><span id="signin-prompt">Initializing...</span></div>
    <div class="controls">
      <button id="sign-in" class="small" style="display:none">Sign In</button>
      <button id="sign-out" class="small" style="display:none">Sign Out</button>
    </div>
  </div>

  <div id="coin-count">Coins: 0</div>

  <button id="click-button" aria-live="polite" disabled>
    <span class="spinner" id="spinner" aria-hidden="true"></span>
    <span id="btn-text">Loading...</span>
  </button>

  <button id="leaderboard-btn">Leaderboard</button>

  <div class="meta">Click the button to earn 1 coin. Coins are tied to your Google account.</div>

  <div class="sell-section">
    <div>Sell coins:</div>
    <input type="number" id="sell-input" value="10" min="1">
    <button id="sell-btn">Sell</button>
    <div id="sold-coins-count">Global Sold Coins: 0</div>
  </div>

  <div id="leaderboard" style="display:none;flex-direction:column;align-items:center;">
    <span class="close" id="lb-close">&times;</span>
    <h2>Leaderboard</h2>
    <div id="lb-content" style="width:100%;display:flex;flex-direction:column;align-items:center;"></div>
  </div>

  <div id="alert-container"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, get, onValue, runTransaction, query, orderByChild, limitToLast, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDmTojLCY55Y-M3nA-NVa0qhGmW2MGJlQg",
  authDomain: "coinclicker-a1b57.firebaseapp.com",
  projectId: "coinclicker-a1b57",
  storageBucket: "coinclicker-a1b57.firebasestorage.app",
  messagingSenderId: "932444438707",
  appId: "1:932444438707:web:23a6b1ad3027f1b3f330c6",
  measurementId: "G-RJ4ZTDMV30",
  databaseURL: "https://coinclicker-a1b57-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
try { getAnalytics(app); } catch (e) { console.warn("Analytics failed to load:", e); }
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db = getDatabase(app);

const button = document.getElementById('click-button');
const spinner = document.getElementById('spinner');
const btnText = document.getElementById('btn-text');
const coinCount = document.getElementById('coin-count');
const userInfo = document.getElementById('user-info');
const signOutBtn = document.getElementById('sign-out');
const signInBtn = document.getElementById('sign-in');
const lbBtn = document.getElementById('leaderboard-btn');
const lbClose = document.getElementById('lb-close');
const lbContent = document.getElementById('lb-content');
const leaderboard = document.getElementById('leaderboard');
const sellInput = document.getElementById('sell-input');
const sellBtn = document.getElementById('sell-btn');
const soldCoinsCount = document.getElementById('sold-coins-count');
const alertContainer = document.getElementById('alert-container');

let currentUserId = null;
let userRefUnsubscribe = null;

function showOnUiAlert(title, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert-ui';
    alertDiv.innerHTML = `
        <h3>${title}</h3>
        <p>${message}</p>
        <button onclick="this.closest('.alert-ui').remove()">OK</button>
    `;
    alertContainer.appendChild(alertDiv);
    setTimeout(() => alertDiv.classList.add('show'), 10);
}

function createRipple(e) {
  const circle = document.createElement('span');
  const rect = button.getBoundingClientRect();
  const diameter = Math.max(rect.width, rect.height);
  const radius = diameter / 2;
  circle.style.width = circle.style.height = diameter + 'px';
  circle.style.left = (e.clientX - rect.left - radius) + 'px';
  circle.style.top = (e.clientY - rect.top - radius) + 'px';
  circle.className = 'ripple';
  const existing = button.getElementsByClassName('ripple')[0];
  if (existing) existing.remove();
  button.appendChild(circle);
}

function enableClickButton() {
  spinner.style.display = 'none';
  btnText.textContent = 'Click Me!';
  button.classList.add('enabled');
  button.disabled = false;
}
function disableClickButton(text = 'Loading...') {
  spinner.style.display = 'inline-block';
  btnText.textContent = text;
  button.classList.remove('enabled');
  button.disabled = true;
}

button.addEventListener('click', async (e) => {
  if (!button.classList.contains('enabled') || !currentUserId) return;
  createRipple(e);
  
  const userCoinsRef = ref(db, `users/${currentUserId}/coins`);
  try {
    const transactionResult = await runTransaction(userCoinsRef, current => {
      return (current || 0) + 1;
    });

    if (transactionResult.committed) {
        coinCount.textContent = `Coins: ${transactionResult.snapshot.val()}`;
    }

  } catch (err) {
    console.error("Transaction failed:", err);
    showOnUiAlert("Error", "Failed to update coins. Please try again.");
  }
});

sellBtn.addEventListener('click', async () => {
    if (!currentUserId) {
        showOnUiAlert("Sign In Required", "Please sign in to sell coins.");
        return;
    }
    const amountToSell = parseInt(sellInput.value, 10);
    if (amountToSell <= 0 || isNaN(amountToSell)) {
        showOnUiAlert("Invalid Amount", "Please enter a valid number of coins to sell.");
        return;
    }

    const userCoinsRef = ref(db, `users/${currentUserId}/coins`);
    const soldCoinsRef = ref(db, 'soldCoins');

    try {
        const userTransaction = await runTransaction(userCoinsRef, currentCoins => {
            const newCoins = (currentCoins || 0) - amountToSell;
            if (newCoins < 0) {
                return; // Abort if not enough coins
            }
            return newCoins;
        });

        if (userTransaction.committed) {
            // Only if the user's coins were successfully updated, update the global counter.
            await runTransaction(soldCoinsRef, currentSold => (currentSold || 0) + amountToSell);
            showOnUiAlert("Success!", `${amountToSell} coins sold successfully!`);
        } else {
            showOnUiAlert("Failed", "You do not have enough coins to sell.");
        }
    } catch (err) {
        console.error("Sell transaction failed:", err);
        showOnUiAlert("Error", "An error occurred during the transaction. Please try again.");
    }
});

signInBtn.addEventListener('click', async () => {
  disableClickButton('Signing in...');
  try {
    await signInWithPopup(auth, provider);
  } catch (e) {
    console.warn("Sign-in failed:", e);
    showOnUiAlert("Sign-in Failed", "Could not sign in with Google. Please try again.");
    disableClickButton('Sign in to play');
  }
});

signOutBtn.addEventListener('click', async () => {
  disableClickButton('Signing out...');
  try {
    await signOut(auth);
  } catch (e) {
    console.error("Sign-out failed:", e);
    showOnUiAlert("Sign-out Failed", "Could not sign out. Please try again.");
  }
});

onAuthStateChanged(auth, user => {
  if (userRefUnsubscribe) {
    userRefUnsubscribe();
    userRefUnsubscribe = null;
  }
  if (user) {
    currentUserId = user.uid;
    signOutBtn.style.display = '';
    signInBtn.style.display = 'none';
    userInfo.innerHTML = `${user.photoURL ? `<img class="avatar" src="${user.photoURL}" alt="User avatar">` : ''}<div><div style="font-weight:600">${user.displayName || user.email}</div><div style="font-size:12px; color:var(--text-muted)">${user.email || ''}</div></div>`;
    
    const userRef = ref(db, `users/${currentUserId}`);
    
    get(userRef).then(snap => {
        if (!snap.exists()) {
            set(userRef, { 
                coins: 0, 
                createdAt: Date.now(), 
                displayName: user.displayName || null, 
                photoURL: user.photoURL || null
            });
        }
    });

    const off = onValue(userRef, snap => {
      const val = snap.val();
      const coins = val ? val.coins || 0 : 0;
      coinCount.textContent = `Coins: ${coins}`;
    });
    userRefUnsubscribe = off;
    enableClickButton();
  } else {
    currentUserId = null;
    userInfo.innerHTML = '<span id="signin-prompt">Not signed in</span>';
    signOutBtn.style.display = 'none';
    signInBtn.style.display = '';
    disableClickButton('Sign in to play');
    coinCount.textContent = 'Coins: 0';
  }
});

lbBtn.addEventListener('click', async () => {
  leaderboard.style.display = 'flex';
  lbContent.innerHTML = '';
  
  for (let i = 0; i < 5; i++) {
    const ph = document.createElement('div');
    ph.className = 'leaderboard-entry shimmer';
    ph.style.height = '60px';
    lbContent.appendChild(ph);
  }

  try {
    const usersRef = ref(db, 'users');
    const q = query(usersRef, orderByChild('coins'), limitToLast(10));
    const snap = await get(q);
    
    lbContent.innerHTML = '';
    
    if (snap.exists()) {
      const entries = [];
      snap.forEach(childSnap => {
          entries.push(childSnap.val());
      });
      
      // Sort in descending order of coins
      entries.sort((a, b) => b.coins - a.coins);

      if (entries.length > 0) {
        entries.forEach((e, index) => {
          const div = document.createElement('div');
          div.className = 'leaderboard-entry';
          div.innerHTML = `
            <div style="font-weight:700; font-size:1.2em; width:20px;">${index + 1}</div>
            ${e.photoURL ? `<img src="${e.photoURL}" alt="Avatar">` : ''}
            <div style="flex:1;text-align:left;">
              <strong>${e.displayName || 'Anonymous'}</strong>
            </div>
            <div style="font-weight:600; color: var(--accent);">${e.coins || 0}💰</div>
          `;
          lbContent.appendChild(div);
        });
      } else {
         lbContent.innerHTML = '<div style="color:white;text-align:center;">No data yet. Be the first!</div>';
      }
    } else {
      lbContent.innerHTML = '<div style="color:white;text-align:center;">No data yet. Be the first!</div>';
    }
  } catch (e) {
    console.error("Error loading leaderboard:", e);
    lbContent.innerHTML = '<div style="color:white;text-align:center;">Error loading leaderboard. Please try again.</div>';
  }
});

const soldCoinsRef = ref(db, 'soldCoins');
onValue(soldCoinsRef, (snapshot) => {
    const totalSold = snapshot.val() || 0;
    soldCoinsCount.textContent = `Global Sold Coins: ${totalSold}`;
});

lbClose.addEventListener('click', () => {
  leaderboard.style.display = 'none';
});

disableClickButton('Initializing...');
</script>
</body>
</html>

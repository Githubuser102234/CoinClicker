<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Coin Clicker</title>
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #fff;
      --muted: #6b7280;
      --accent: #4caf50;
      --button-gray: #9ca3af;
    }
    html,body { height:100%; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); display:flex; align-items:center; justify-content:center; }

    .container {
      width: 360px;
      max-width: calc(100% - 32px);
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(15,23,42,0.08);
      padding: 18px;
      text-align: center;
    }

    .top {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 14px;
      gap: 8px;
    }
    .user {
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size: 14px;
      min-height: 40px;
    }
    .avatar {
      width:34px; height:34px; border-radius:50%; object-fit:cover; box-shadow: 0 1px 0 rgba(0,0,0,0.05);
    }
    .controls { display:flex; gap:8px; align-items:center; }

    button.small {
      padding:6px 10px;
      font-size:13px;
      border-radius:8px;
      border: none;
      cursor:pointer;
      background: #efefef;
    }

    #coin-count {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color:#111827;
    }

    /* Click button */
    #click-button {
      position:relative;
      overflow:hidden;
      padding: 14px 40px;
      font-size: 18px;
      color: white;
      background-color: var(--button-gray);
      border: none;
      border-radius: 12px;
      cursor: not-allowed;
      outline: none;
      display: inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 200px;
      user-select: none;
      transition: transform 80ms ease, background-color 150ms;
      box-shadow: 0 6px 14px rgba(2,6,23,0.07);
    }
    #click-button.enabled {
      background-color: var(--accent);
      cursor: pointer;
    }
    #click-button:active.enabled { transform: translateY(1px) scale(0.998); }

    .spinner {
      border: 3px solid rgba(255,255,255,0.28);
      border-top: 3px solid rgba(255,255,255,0.98);
      border-radius: 50%;
      width: 18px;
      height: 18px;
      animation: spin 900ms linear infinite;
      margin-right: 10px;
      display:inline-block;
      vertical-align:middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .ripple {
      position:absolute;
      border-radius:50%;
      transform:scale(0);
      animation: ripple 600ms linear;
      background: rgba(255,255,255,0.7);
      pointer-events: none;
      will-change: transform, opacity;
    }
    @keyframes ripple {
      to { transform: scale(4); opacity: 0; }
    }

    .meta { color:var(--muted); font-size:13px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="Coin Clicker">
    <div class="top">
      <div class="user" id="user-info">
        <span id="signin-prompt">Initializing...</span>
      </div>
      <div class="controls">
        <button id="sign-in" class="small" style="display:none">Sign In</button>
        <button id="sign-out" class="small" style="display:none">Sign Out</button>
      </div>
    </div>

    <div id="coin-count">Coins: 0</div>

    <button id="click-button" aria-live="polite" disabled>
      <span class="spinner" id="spinner" aria-hidden="true"></span>
      <span id="btn-text">Loading...</span>
    </button>

    <div class="meta">Click the button to earn 1 coin. Coins are tied to your Google account.</div>
  </div>

  <script type="module">
    // --- Firebase imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, get, set, update, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    // --- Your Firebase config (kept from your snippet; added databaseURL) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDmTojLCY55Y-M3nA-NVa0qhGmW2MGJlQg",
      authDomain: "coinclicker-a1b57.firebaseapp.com",
      projectId: "coinclicker-a1b57",
      storageBucket: "coinclicker-a1b57.firebasestorage.app",
      messagingSenderId: "932444438707",
      appId: "1:932444438707:web:23a6b1ad3027f1b3f330c6",
      measurementId: "G-RJ4ZTDMV30",
      databaseURL: "https://coinclicker-a1b57-default-rtdb.firebaseio.com/"
    };

    // --- Init Firebase ---
    const app = initializeApp(firebaseConfig);
    // analytics is optional and can fail on some origins (file://); we try/catch to avoid blocking app.
    try { getAnalytics(app); } catch(e) { /* ignore analytics init errors */ }

    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getDatabase(app);

    // --- DOM ---
    const button = document.getElementById('click-button');
    const spinner = document.getElementById('spinner');
    const btnText = document.getElementById('btn-text');
    const coinCount = document.getElementById('coin-count');
    const userInfo = document.getElementById('user-info');
    const signOutBtn = document.getElementById('sign-out');
    const signInBtn = document.getElementById('sign-in');

    // --- State ---
    let currentUserId = null;
    let suppressAutoSignIn = false; // when user explicitly signs out, we won't auto-popup the login
    let coins = 0;
    let userRefUnsubscribe = null;

    // visual helpers
    function enableClickButton() {
      spinner.style.display = 'none';
      btnText.textContent = 'Click Me!';
      button.classList.add('enabled');
      button.disabled = false;
      button.style.cursor = 'pointer';
    }
    function disableClickButton(loadingText = 'Loading...') {
      spinner.style.display = '';
      btnText.textContent = loadingText;
      button.classList.remove('enabled');
      button.disabled = true;
      button.style.cursor = 'not-allowed';
    }

    // small ripple helper
    function createRipple(e) {
      const circle = document.createElement('span');
      const rect = button.getBoundingClientRect();
      const diameter = Math.max(rect.width, rect.height);
      const radius = diameter / 2;
      circle.style.width = circle.style.height = diameter + 'px';
      circle.style.left = (e.clientX - rect.left - radius) + 'px';
      circle.style.top = (e.clientY - rect.top - radius) + 'px';
      circle.className = 'ripple';
      const existing = button.getElementsByClassName('ripple')[0];
      if (existing) existing.remove();
      button.appendChild(circle);
      setTimeout(() => circle.remove(), 700);
    }

    // --- Click handler: use atomic transaction to increment coins server-side ---
    button.addEventListener('click', async (e) => {
      if (!button.classList.contains('enabled') || !currentUserId) return;
      createRipple(e);

      // quick local optimistic UI bump (will be corrected by onValue listener)
      coins = (coins || 0) + 1;
      coinCount.textContent = 'Coins: ' + coins;

      const coinsRef = ref(db, `users/${currentUserId}/coins`);
      try {
        await runTransaction(coinsRef, (current) => {
          return (current || 0) + 1;
        });
        // onValue listener will pick up final value; nothing else required here
      } catch (err) {
        console.error('Transaction error', err);
        // rollback local optimistic change if desired: fetch current
        const snap = await get(coinsRef);
        coins = snap.exists() ? (snap.val() || 0) : 0;
        coinCount.textContent = 'Coins: ' + coins;
        alert('Could not increment coins — check network/console.');
      }
    });

    // Sign-in and Sign-out button handlers
    signInBtn.addEventListener('click', async () => {
      suppressAutoSignIn = false;
      disableClickButton('Signing in...');
      signInBtn.style.display = 'none';
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error('Sign in failed', err);
        disableClickButton('Sign in to play');
        signInBtn.style.display = '';
        alert('Sign-in failed or canceled.');
      }
    });

    signOutBtn.addEventListener('click', async () => {
      suppressAutoSignIn = true;
      disableClickButton('Signing out...');
      try {
        await signOut(auth);
        // onAuthStateChanged will handle UI changes
      } catch (err) {
        console.error('Sign out failed', err);
        alert('Sign out failed — check console.');
      }
    });

    // Auth state observer
    onAuthStateChanged(auth, async (user) => {
      // cleanup previous DB listener
      if (typeof userRefUnsubscribe === 'function') {
        userRefUnsubscribe();
        userRefUnsubscribe = null;
      }

      if (user) {
        // signed in
        currentUserId = user.uid;
        signOutBtn.style.display = '';
        signInBtn.style.display = 'none';
        userInfo.innerHTML = `
          ${user.photoURL ? `<img class="avatar" src="${user.photoURL}" alt="avatar">` : ''}
          <div style="text-align:left">
            <div style="font-weight:600; font-size:14px;">${user.displayName || user.email}</div>
            <div style="font-size:12px; color:var(--muted)">${user.email || ''}</div>
          </div>
        `;
        // ensure DB record exists
        const uRef = ref(db, `users/${currentUserId}`);
        try {
          const snap = await get(uRef);
          if (!snap.exists()) {
            await set(uRef, { coins: 0, createdAt: Date.now(), displayName: user.displayName || null });
            coins = 0;
            coinCount.textContent = 'Coins: 0';
          } else {
            const val = snap.val();
            coins = val.coins || 0;
            coinCount.textContent = 'Coins: ' + coins;
            // update displayName if changed
            const needUpdate = (val.displayName !== user.displayName);
            if (needUpdate) await update(uRef, { displayName: user.displayName || null });
          }
        } catch (err) {
          console.error('DB init error', err);
          alert('Could not read/write user data — check DB rules & console.');
        }

        // Realtime listener for this user's record
        const liveRef = ref(db, `users/${currentUserId}`);
        const off = onValue(liveRef, (snap) => {
          if (!snap.exists()) return;
          const data = snap.val();
          const serverCoins = data.coins || 0;
          coins = serverCoins;
          coinCount.textContent = 'Coins: ' + serverCoins;
        }, (err) => {
          console.error('onValue error', err);
        });
        // onValue returns an unsubscribe function (not directly, but we can emulate)
        userRefUnsubscribe = () => { off(); };

        // enable click button
        enableClickButton();
      } else {
        // signed out
        currentUserId = null;
        userInfo.textContent = 'Not signed in';
        signOutBtn.style.display = 'none';
        // If the user explicitly signed out, don't auto-popup sign-in
        if (!suppressAutoSignIn) {
          // Attempt to open sign-in immediately (previous behavior). If user cancels or an error occurs,
          // we'll show a Sign In button so they can sign in manually without a forced popup.
          try {
            await signInWithPopup(auth, provider);
            // if successful, onAuthStateChanged will re-run and handle setup
            return;
          } catch (err) {
            console.warn('Auto sign-in popup suppressed by user or failed', err);
            signInBtn.style.display = '';
            disableClickButton('Sign in to play');
          }
        } else {
          // user chose to sign out -> show sign in button and stop auto popups
          signInBtn.style.display = '';
          disableClickButton('Signed out');
        }
      }
    });

    // initial UI state
    disableClickButton('Initializing...');
  </script>
</body>
</html>
